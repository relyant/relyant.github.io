name: Process Journal Entry
on:
  push:
    paths:
      - '_incoming/**'
      - '!assets/**'
  workflow_dispatch:

concurrency:
  group: journal-processing
  cancel-in-progress: false

jobs:
  convert-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Wait for Sync (Safety Buffer)
        run: sleep 5

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Image Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick webp

      - name: Process Journal Entries
        run: |
          git config --global user.name 'Journal Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          mkdir -p _posts
          shopt -s nullglob

          has_changes=false

          for file in _incoming/*.md; do
            echo "Processing $file..."
            
            # 1. READ METADATA
            raw_title=$(grep -m 1 "^# " "$file" | sed 's/^# //' | xargs || true)
            title="${raw_title:-Journal Entry}"
            filename=$(basename "$file")
            
            # Generate Slug
            slug=$(echo "$title" | sed -e 's/[^[:alnum:]]/-/g' | tr -s '-' | tr A-Z a-z | sed 's/^-//;s/-$//')
            date_part=$(echo "$filename" | cut -d. -f1)
            new_filename="${date_part}-${slug}.md"
            
            # --- IMAGE PROCESSING ---
            # 1. Convert images and rewrite links in the $file
            grep -oP '(?<=\]\(\.\./).*?(?=\))' "$file" | while read -r match; do
              clean_path="${match#/}"
              
              if [ -f "$clean_path" ]; then
                echo "Converting image: $clean_path"
                new_img_path="${clean_path%.*}.webp"
                
                # Convert: Resize to FHD, WebP format
                convert "$clean_path" -resize '1920x1080>' -quality 80 -define webp:lossless=false "$new_img_path"
                
                if [ -f "$new_img_path" ]; then
                  # Update link in markdown: ../assets/img.jpg -> /assets/img.webp
                  sed -i "s|\.\./$match|/$new_img_path|g" "$file"
                  
                  git add "$new_img_path"
                  git rm "$clean_path"
                fi
              fi
            done
            
            # 2. Extract First Image path (for YAML header)
            # We look for the first markdown link that starts with /assets inside the processed file
            featured_image=$(grep -oP -m 1 '(?<=\]\()/assets/.*?(?=\))' "$file" | head -n 1)
            # ------------------------

            # 3. CREATE POST
            echo "---" > temp_post.md
            echo "layout: post" >> temp_post.md
            printf "title: \"%s\"\n" "$title" >> temp_post.md
            
            # If we found an image, add it to YAML
            if [ ! -z "$featured_image" ]; then
               echo "image: $featured_image" >> temp_post.md
            fi
            
            # Move metadata (excluding title, layout, and image to avoid dupes)
            sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d' | \
            sed 's/^created:/date:/' | \
            grep -v "^title:" | grep -v "^layout:" | grep -v "^image:" >> temp_post.md || true
            
            echo "---" >> temp_post.md
            
            # 4. APPEND BODY
            awk 'BEGIN {count=0} /^---$/ {count++; next} count>=2 {print}' "$file" >> temp_body.md
            grep -v "^# $raw_title" temp_body.md >> temp_post.md || cat temp_body.md >> temp_post.md
            rm temp_body.md

            # 5. FINAL ACTIONS
            mv temp_post.md "_posts/$new_filename"
            
            git rm -f "$file"
            git add "_posts/$new_filename"
            
            has_changes=true
          done

          if [ "$has_changes" = true ]; then
            git pull --rebase --autostash
            git commit -m "Processed: optimized images, added yaml cover & moved posts"
            git push
          else
            echo "No markdown files to process."
          fi
