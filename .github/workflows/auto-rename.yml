name: Auto Rename Posts with Slug
on:
  workflow_dispatch: # This allows you to run it manually via a button

jobs:
  rename-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install python-frontmatter python-slugify

      - name: Rename files based on Title
        run: |
          python3 -c "
          import os
          import frontmatter
          from slugify import slugify
          import re

          posts_dir = '_posts'
          
          # Regex to find files that created by GitJournal (just date.md)
          # Format: YYYY-MM-DD.md or YYYY-MM-DD-HHMM.md
          pattern = re.compile(r'^\d{4}-\d{2}-\d{2}(-\d{4})?\.md$')

          for filename in os.listdir(posts_dir):
              if pattern.match(filename):
                  filepath = os.path.join(posts_dir, filename)
                  
                  try:
                      post = frontmatter.load(filepath)
                      if post.get('title'):
                          # Keep the date part (first 10 chars)
                          date_part = filename[:10] 
                          slug = slugify(post['title'])
                          new_filename = f'{date_part}-{slug}.md'
                          new_filepath = os.path.join(posts_dir, new_filename)
                          
                          print(f'Renaming: {filename} -> {new_filename}')
                          os.rename(filepath, new_filepath)
                  except Exception as e:
                      print(f'Skipping {filename}: {e}')
          "

      - name: Commit and Push changes
        run: |
          git config --global user.name "Renamer Bot"
          git config --global user.email "bot@noreply.github.com"
          git add _posts/*
          git commit -m "Auto-renamed posts with slugs" || exit 0
          git push
