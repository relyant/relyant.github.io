name: Add Random ID to Filenames
on:
  workflow_dispatch: # Run manually via button

jobs:
  rename-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Rename Files with Random Numbers
        run: |
          python3 -c "
          import os
          import re
          import random

          posts_dir = '_posts'
          
          # Regex matches ONLY 'YYYY-MM-DD.md'
          # It will IGNORE files that already have the number added
          pattern = re.compile(r'^\d{4}-\d{2}-\d{2}\.md$')

          files_changed = False

          if os.path.exists(posts_dir):
              for filename in os.listdir(posts_dir):
                  if pattern.match(filename):
                      old_path = os.path.join(posts_dir, filename)
                      
                      # Get the first 10 chars (The Date: 2024-05-21)
                      date_part = filename[:10]
                      
                      # Generate a random 4-digit number
                      rand_num = random.randint(1000, 9999)
                      
                      # New name: Date + Number (No Dash) + .md
                      new_filename = f'{date_part}{rand_num}.md'
                      new_path = os.path.join(posts_dir, new_filename)
                      
                      print(f'Renaming: {filename} -> {new_filename}')
                      os.rename(old_path, new_path)
                      files_changed = True
          else:
              print(f'Directory {posts_dir} not found.')

          # Verify changes were made for the commit step
          if not files_changed:
              print('No files needed renaming.')
          "

      - name: Commit and Push
        run: |
          if [[ -n $(git status -s) ]]; then
            git config --global user.name "Renamer Bot"
            git config --global user.email "bot@noreply.github.com"
            git add _posts/*
            git commit -m "Appended random IDs to filenames"
            git push
          else
            echo "No changes to commit."
          fi
