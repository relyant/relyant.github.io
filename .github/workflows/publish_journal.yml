name: Process Journal Entry
on:
  push:
    paths:
      - '_incoming/**'
      # We ignore assets here so the bot doesn't trigger itself when it commits the converted images
      - '!assets/**'

concurrency:
  group: journal-processing
  cancel-in-progress: false

jobs:
  convert-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Wait for Sync (Safety Buffer)
        run: sleep 30

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Image Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick webp

      - name: Process Journal Entries
        run: |
          # --- CONFIGURATION ---
          git config --global user.name 'Journal Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          mkdir -p _posts
          shopt -s nullglob

          has_changes=false

          for file in _incoming/*.md; do
            echo "Processing $file..."
            
            # 1. READ METADATA
            raw_title=$(grep -m 1 "^# " "$file" | sed 's/^# //' | xargs || true)
            title="${raw_title:-Journal Entry}"
            filename=$(basename "$file")
            
            # Generate Slug
            slug=$(echo "$title" | sed -e 's/[^[:alnum:]]/-/g' | tr -s '-' | tr A-Z a-z | sed 's/^-//;s/-$//')
            date_part=$(echo "$filename" | cut -d. -f1)
            new_filename="${date_part}-${slug}.md"
            
            # --- IMAGE PROCESSING STARTS HERE ---
            # We look for markdown image links: ![Alt](../assets/images/file.jpg)
            # The regex extracts the path after '](../'
            
            grep -oP '(?<=\]\(\.\./).*?(?=\))' "$file" | while read -r match; do
              # The match usually comes with a leading slash like /assets/..., we remove it to find the file
              clean_path="${match#/}"
              
              if [ -f "$clean_path" ]; then
                echo "Converting image: $clean_path"
                new_img_path="${clean_path%.*}.webp"
                
                # Convert to Full HD WebP (max 1920px wide/high)
                convert "$clean_path" -resize '1920x1080>' -quality 80 -define webp:lossless=false "$new_img_path"
                
                if [ -f "$new_img_path" ]; then
                  # Update link in file: ../assets/img.jpg -> /assets/img.webp
                  # escape slashes for sed
                  sed -i "s|\.\./$clean_path|/$new_img_path|g" "$file"
                  sed -i "s|\.\./$match|/$new_img_path|g" "$file"
                  
                  git add "$new_img_path"
                  git rm "$clean_path"
                fi
              else
                echo "Warning: Image $clean_path not found on disk."
              fi
            done
            # --- IMAGE PROCESSING ENDS ---

            # 2. CREATE NEW POST CONTENT
            echo "---" > temp_post.md
            echo "layout: post" >> temp_post.md
            printf "title: \"%s\"\n" "$title" >> temp_post.md
            
            # Move created -> date
            sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d' | \
            sed 's/^created:/date:/' | \
            grep -v "^title:" | grep -v "^layout:" >> temp_post.md || true
            
            echo "---" >> temp_post.md
            
            # 3. APPEND BODY
            awk 'BEGIN {count=0} /^---$/ {count++; next} count>=2 {print}' "$file" >> temp_body.md
            
            # Remove duplicate H1 title if present
            grep -v "^# $raw_title" temp_body.md >> temp_post.md || cat temp_body.md >> temp_post.md
            rm temp_body.md

            # 4. FINAL MOVE
            mv temp_post.md "_posts/$new_filename"
            
            # FORCE REMOVE original (added -f to fix your specific error)
            git rm -f "$file"
            git add "_posts/$new_filename"
            
            has_changes=true
          done

          if [ "$has_changes" = true ]; then
            git pull --rebase --autostash
            git commit -m "Processed journal: converted images to WebP & moved posts"
            git push
          else
            echo "No markdown files to process."
          fi
