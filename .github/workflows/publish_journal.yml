name: Process Journal Entry
on:
  push:
    paths:
      - '_incoming/**'

jobs:
  convert-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Wait for Sync to Finish
        run: sleep 30
        
      - name: Convert and Move Files
        run: |
          # 1. SETUP
          git config --global user.name 'Journal Bot'
          git config --global user.email 'bot@noreply.github.com'
          mkdir -p _posts
          shopt -s nullglob
          
          has_changes=false

          for file in _incoming/*.md; do
            echo "Processing $file..."
            
            # Fix Line Endings (Change Windows CRLF to Linux LF)
            sed -i 's/\r$//' "$file"

            # 2. EXTRACT DATA
            filename=$(basename "$file")
            
            # Extract Title: Find first line starting with #. 
            # "|| true" prevents crash if no title found.
            raw_title=$(grep -m 1 "^# " "$file" | sed 's/^# //' | xargs || true)
            
            if [ -z "$raw_title" ]; then
                title="Journal Entry"
            else
                title="$raw_title"
            fi
            
            # Create Slug (URL-friendly title)
            slug=$(echo "$title" | sed -e 's/[^[:alnum:]]/-/g' | tr -s '-' | tr A-Z a-z | sed 's/^-//;s/-$//')
            
            # Get Date from filename
            date_part=$(echo "$filename" | cut -d. -f1)
            new_filename="${date_part}-${slug}.md"
            
            # 3. CONSTRUCT NEW FILE ('temp_post.md')
            echo "---" > temp_post.md
            echo "layout: post" >> temp_post.md
            # Use printf to handle special characters in title safely
            printf "title: \"%s\"\n" "$title" >> temp_post.md
            
            # Extract existing YAML (metadata)
            # rename 'created' to 'date', remove existing title/layout to avoid dupes
            sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d' | \
            sed 's/^created:/date:/' | \
            grep -v "^title:" | grep -v "^layout:" >> temp_post.md || true
            
            echo "---" >> temp_post.md
            
            # 4. APPEND BODY CONTENT
            # Use awk to reliably print everything AFTER the second '---' separator
            awk 'BEGIN {count=0} /^---$/ {count++; next} count>=2 {print}' "$file" >> temp_body.md
            
            # Remove the H1 Title from the body if it exists (so it doesn't show twice)
            # We use a temp file logic to allow grep to fail gracefully
            grep -v "^# $raw_title" temp_body.md >> temp_post.md || cat temp_body.md >> temp_post.md
            
            # Cleanup temp body
            rm temp_body.md

            # 5. MOVE AND COMMIT
            mv temp_post.md "_posts/$new_filename"
            git rm "$file"
            git add "_posts/$new_filename"
            
            has_changes=true
          done

          if [ "$has_changes" = true ]; then
            git commit -m "Auto-published journal entries"
            git push
          else
            echo "No valid markdown files found to process."
          fi
